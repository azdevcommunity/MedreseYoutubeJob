name: Build & Deploy (Medrese Job - .NET)

on:
  push:
    branches: ["main"]

env:
  IMAGE_NAME: ghcr.io/azdevcommunity/medrese-job
  APP_PORT: 8085

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: VPS
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=sha
            type=raw,value=latest

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: VPS
    steps:
      - name: Fail fast if required secrets are empty
        run: |
          [ -n "${{ secrets.DATABASE_HOST }}" ]     || { echo "❌ DATABASE_HOST is EMPTY in Environment 'VPS'"; exit 1; }
          [ -n "${{ secrets.DATABASE_USERNAME }}" ] || { echo "❌ DATABASE_USERNAME is EMPTY in Environment 'VPS'"; exit 1; }
          [ -n "${{ secrets.DATABASE_PASSWORD }}" ] || { echo "❌ DATABASE_PASSWORD is EMPTY in Environment 'VPS'"; exit 1; }
          [ -n "${{ secrets.DATABASE_PORT }}" ]     || { echo "❌ DATABASE_PORT is EMPTY in Environment 'VPS'"; exit 1; }
          [ -n "${{ secrets.DATABASE_NAME }}" ]     || { echo "❌ DATABASE_NAME is EMPTY in Environment 'VPS'"; exit 1; }
          [ -n "${{ secrets.GHCR_USERNAME }}" ]     || { echo "❌ GHCR_USERNAME is EMPTY"; exit 1; }
          [ -n "${{ secrets.GHCR_TOKEN }}" ]        || { echo "❌ GHCR_TOKEN is EMPTY"; exit 1; }
          [ -n "${{ secrets.VPS_HOST }}" ]          || { echo "❌ VPS_HOST is EMPTY"; exit 1; }
          [ -n "${{ secrets.VPS_USER }}" ]          || { echo "❌ VPS_USER is EMPTY"; exit 1; }
          [ -n "${{ secrets.VPS_SSH_KEY }}" ]       || { echo "❌ VPS_SSH_KEY is EMPTY"; exit 1; }

      - name: SSH into server and deploy (compose)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e

            # Hazırlık
            docker network create esm_network || true
            mkdir -p /opt/medrese
            mkdir -p /etc/medrese/prod

            IMAGE="${{ env.IMAGE_NAME }}:latest"
            APP_PORT="${{ env.APP_PORT }}"

            echo "[GHCR] Login (server-side pull)"
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

            echo "[Pull] $IMAGE"
            docker pull "$IMAGE"

            echo "[ENV] write /etc/medrese/prod/medrese-job.env"
            umask 077
            cat > /etc/medrese/prod/medrese-job.env <<EOF
            ASPNETCORE_ENVIRONMENT=Production
            ASPNETCORE_URLS=http://+:${APP_PORT}

            # .NET ConfigurationBinder: DB section (double underscore)
            DB__Host=${{ secrets.DATABASE_HOST }}
            DB__Username=${{ secrets.DATABASE_USERNAME }}
            DB__Password=${{ secrets.DATABASE_PASSWORD }}
            DB__Port=${{ secrets.DATABASE_PORT }}
            DB__Name=${{ secrets.DATABASE_NAME }}
            EOF
            chmod 600 /etc/medrese/prod/medrese-job.env

            echo "[ENV] preview (masked)"
            grep -E '^(ASPNETCORE_ENVIRONMENT|ASPNETCORE_URLS|DB__Host|DB__Username|DB__Port|DB__Name)=' /etc/medrese/prod/medrese-job.env | sed 's/=.*/=****/'

            # Deploy (Compose)
            cd /opt/medrese
            export IMAGE_TAG=latest
            if [ ! -f compose.prod.yml ]; then
              echo "❌ /opt/medrese/compose.prod.yml bulunamadı"
              exit 1
            fi
            docker compose -f compose.prod.yml pull medrese-job
            docker compose -f compose.prod.yml up -d --no-deps medrese-job

            # Sağlık kontrolü
            HEALTH_PATH="${{ secrets.HEALTH_PATH }}"
            [ -n "$HEALTH_PATH" ] || HEALTH_PATH="/"
            echo "[Health] http://127.0.0.1:${APP_PORT}${HEALTH_PATH}"
            ok=0
            for i in $(seq 1 30);  do
              if curl -fsS "http://127.0.0.1:${APP_PORT}${HEALTH_PATH}" >/dev/null 2>&1; then
                echo "UP"; ok=1; break
              fi
              sleep 1
            done
            if [ "$ok" -ne 1 ]; then
              echo "⚠️ Healthcheck failed (devam)"
            fi

            echo "[Status]"
            docker compose -f compose.prod.yml ps

            echo "[Logs tail]"
            docker logs --tail=50 medrese-job || true

            echo "[Cleanup] prune dangling images"
            docker image prune -f
